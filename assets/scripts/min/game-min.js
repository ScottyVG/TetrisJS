var drMarioGame=drMarioGame||{};drMarioGame.Game=function(){},console.log("Game state loaded"),drMarioGame.Game.prototype={create:function(){function e(){z%W==0&&(re.delay-=C,R+=D)}function t(){var e=J.x+J.textWidth/2;Q.x=e-.5*Q.textWidth,Z.x=e-.5*Z.textWidth}function r(){for(;Y.length<O+1;)Y.unshift(new Tetromino);H=Y.pop();var e=Math.floor(k/2),t=P[H.shape],r=H.materialize(e,t,!0);if(r)v();else for(var a=0;a<Y.length;a++){var i=Math.floor((J.x+J.textWidth/2)/32),o=14;Y[a].materialize(i,o,!1)}}function a(e,t){var r=H.cells[e][0]+X[t][0],a=H.cells[e][1]+X[t][1];return[r,a]}function i(e){var t=H.center[0]+X[e][0],r=H.center[1]+X[e][1];return[t,r]}function o(e,t){var r=H.center[0],a=H.center[1],i=H.cells[e][0]-r,o=H.cells[e][1]-a;o=-o;var l="clockwise"==t?o:-o,s="clockwise"==t?-i:i;s=-s;var n=r+l,c=a+s;return[n,c]}function l(e,t){if(A)return!1;for(var r=0;r<H.cells.length;r++){var a=e(r,t),i=a[0],o=a[1];if(!s(i,o))return!1}return!0}function s(e,t){return 0>e||e>k-1?!1:0>t||t>G-1?!1:_[e][t]!=B}function n(e,t,r,a){for(var i=0;i<H.cells.length;i++){var o=H.cells[i][0],l=H.cells[i][1],s=e(i,r),n=s[0],c=s[1];H.cells[i][0]=n,H.cells[i][1]=c,H.sprites[i].x=n*x,H.sprites[i].y=c*x,_[o][l]=0,_[n][c]=j}if(t){var d=t(r);H.center=[d[0],d[1]]}a&&Game.radio.playSound(Game.radio.moveSound)}function c(e){for(var t=0,r=0;k>r;r++)t+=_[r][e];return t}function d(e){for(var t=[],r=0;r<e.length;r++){var a=c(e[r]);a==k*B&&(updateScore(),t.push(e[r]),Game.radio.playSound(Game.radio.winSound),h(e[r]))}t.length&&m(t)}function h(e){for(var t=0,r=0;k>r;r++){var a=game.add.tween(ee[r][e]);a.to({y:0},500,null,!1,t),a.onComplete.add(u,this),a.start(),ee[r][e]=null,_[r][e]=0,t+=50}}function u(e){e.destroy()}function m(e){for(var t=999,r=0;r<e.length;r++)e[r]<t&&(t=e[r]);for(var a=t-1;a>=0;a--)for(var i=0;k>i;i++)if(ee[i][a]){ee[i][a+e.length]=ee[i][a],ee[i][a]=null,_[i][a+e.length]=B,_[i][a]=0;var o=game.add.tween(ee[i][a+e.length]),l=ee[i][a+e.length].y+e.length*x;o.to({y:l},500,null,!1),o.start()}}function p(){console.log("Scene length"+_.length);for(var e=0;e<_.length;e++)for(var t=0;t<_[e].length;t++)console.log(_[e][t])}function g(){if(!A&&!V)if(l(a,"down"))n(a,i,"down",0);else{for(var e=[],t=0;t<H.cells.length;t++){-1==e.indexOf(H.cells[t][1])&&e.push(H.cells[t][1]);var o=H.cells[t][0],s=H.cells[t][1];_[o][s]=B,ee[H.cells[t][0]][H.cells[t][1]]=H.sprites[t]}d(e),r()}}function y(){ae=game.add.graphics(0,0),ae.beginFill(0,.6),ae.drawRect(0,0,game.world.width,game.world.height),ae.endFill()}function f(){A=!A,A?(Game.radio.music.pause(),y(),q=game.add.bitmapText(game.world.centerX,game.world.centerY,"videogame","PAUSE",64),q.anchor.setTo(.5)):(te.resume(),Game.radio.playMusic(),ae.clear(),q.destroy())}function v(){V=!0,game.input.keyboard.enabled=!1,Game.radio.music.pause(),Game.radio.playSound(Game.radio.gameOverSound),y();var e=game.add.bitmapText(game.world.centerX,game.world.centerY,"gameover","GAME OVER",64);e.anchor.setTo(.5),document.getElementById("name").style.display="block"}this.map=this.game.add.tilemap("drMarioLevel"),this.map.addTilesetImage("tiles","gameTiles"),this.backgroundLayer=this.map.createLayer("backgroundLayer"),this.blockedLayer=this.map.createLayer("blockedLayer"),this.map.setCollisionBetween(1,2e3,!0,"blockedLayer"),this.backgroundLayer.resizeWorld();var b=2,w=6,x=16,G=18,k=10,M=k*x,T=300,L=100,S=M+90,O=1,j=1,B=2,E=0,R=50,z=0,W=3,C=100,D=25,F=Phaser.Timer.SECOND,Y=[],A=!1,V=!1,I={0:[[0,0],[1,0]]},P={0:1,1:1,2:0,3:1,4:1,5:0,6:1},X={left:[-1,0],down:[0,1],right:[1,0]},H,K,N,U,q,J,Q,Z,_,ee,te,re,ae,ie=0,oe=this.pillRandomizer();_=[],ee=[];for(var le=0;k>le;le++){for(var se=[],ne=[],ce=0;G>ce;ce++)se.push(0),ne.push(null);_.push(se),ee.push(ne)}console.log(_),this.game.add.tileSprite(0,this.game.world.height-x,M,x,"wall",0),this.game.input.keyboard.enabled=!0,this.createVirus();for(var de=this.game.add.group(),le=0;2>le;le++)de.create(0+16*le,0,oe[le]);this.player=this.game.add.group();var he=this.findObjectsByType("playerStartLeft",this.map,"objectsLayer");this.player=this.game.add.sprite(he[0].x,he[0].y,oe[0]),this.player=this.game.add.sprite(he[0].x+16,he[0].y,oe[1]),this.game.physics.arcade.enable(this.player),this.cursors=this.game.input.keyboard.createCursorKeys()},update:function(){this.currentMovementTimer+=this.time.elapsed,this.game.physics.arcade.collide(this.player,this.blockedLayer),this.game.physics.arcade.collide(this.player,this.virus),this.player.body.velocity.x=0,this.player.body.velocity.y=12,this.cursors.down.isDown?(this.player.body.velocity.y+=100,console.log("down")):this.cursors.left.isDown?(this.player.body.velocity.x-=100,console.log("left")):this.cursors.right.isDown&&(this.player.body.velocity.x+=100,console.log("right"))},findObjectsByType:function(e,t,r){var a=new Array;return t.objects[r].forEach(function(r){r.type===e&&(r.y-=t.tileHeight,a.push(r))}),a},createFromTiledObject:function(e,t){var r=t.create(e.x,e.y,e.properties.sprite);Object.keys(e.properties).forEach(function(t){r[t]=e.properties[t]})},createVirus:function(){this.virus=this.game.add.group(),this.virus.enableBody=!0,result=this.findObjectsByType("virus",this.map,"virusLayer"),result.forEach(function(e){this.createFromTiledObject(e,this.virus)},this)},pillRandomizer:function(){var e=["leftRed","leftYellow","leftBlue"],t=["rightRed","rightYellow","rightBlue"],r=[];return r.push(e[Math.floor(3*Math.random())]),r.push(t[Math.floor(3*Math.random())]),console.log(r),r},destroy:function(e){e.destroy()}};